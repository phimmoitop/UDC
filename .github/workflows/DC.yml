name: M3U8 to DC

on:
  workflow_dispatch:
    inputs:
      link:
        description: "Link"
        required: true
      slug:
        description: "Slug"
        required: true
      webhooklist:
        description: "List"
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # =======================
      # Setup Môi trường
      # =======================
      - name: Setup Environment
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl jq python3

      # =======================
      # b1: Tải m3u8 → mp4
      # =======================
      - name: Download m3u8 to mp4
        run: |
          ffmpeg -i "${{ inputs.link }}" -c copy -bsf:a aac_adtstoasc "${{ inputs.slug }}.mp4"

      # =======================
      # b2: Cắt HLS (fmp4) giống PHP
      # =======================
      - name: Convert to HLS
        run: |
          mkdir -p output
          ffmpeg -y -i "${{ inputs.slug }}.mp4" -codec: copy \
            -start_number 10001 -hls_time 4 \
            -hls_flags split_by_time+independent_segments -hls_list_size 0 \
            -hls_segment_type fmp4 \
            -hls_fmp4_init_filename "${{ inputs.slug }}-index.html" \
            -hls_segment_filename "output/${{ inputs.slug }}-index%d.html" \
            -f hls "output/${{ inputs.slug }}.m3u8"

      # =======================
      # b3: Xử lý Upload và Encode (Logic PHP)
      # =======================
      - name: Process and Upload to Discord
        run: |
          # 1. Tải file mồi JPG (0.txt) về máy, giữ nguyên định dạng nhị phân
          curl -sL https://raw.githubusercontent.com/phimmoitop/UDC/main/0.txt -o header.jpg

          # 2. Tạo script Python để Encode chính xác như PHP
          cat > encode.py <<'PYCODE'
          import sys, hashlib

          def base_convert(n, from_base, to_base):
              try:
                  decimal = int(str(n), from_base)
              except: return "0"
              if decimal == 0: return "0"
              chars = "0123456789abcdefghijklmnopqrstuvwxyz"
              res = ""
              while decimal > 0:
                  decimal, r = divmod(decimal, to_base)
                  res = chars[r] + res
              return res

          def encode(string, key="zzo0ozz"):
              key_hash = hashlib.sha1(key.encode()).hexdigest()
              hash_out = ""
              j = 0
              for i in range(len(string)):
                  if j == len(key_hash): j = 0
                  # Logic: ordStr + ordKey -> dechex -> base36 -> strrev
                  val_dec = ord(string[i]) + ord(key_hash[j])
                  val_hex = hex(val_dec)[2:]
                  val_b36 = base_convert(val_hex, 16, 36)
                  hash_out += val_b36[::-1]
                  j += 1
              return hash_out

          if __name__ == "__main__":
              if len(sys.argv) > 1:
                  print(encode(sys.argv[1]))
          PYCODE

          # 3. Duyệt file và Upload
          IFS=',' read -ra WEBHOOKS <<< "${{ inputs.webhooklist }}"
          M3U8_FILE="output/${{ inputs.slug }}.m3u8"
          
          # Lấy danh sách các file segment .html
          for f in output/*.html; do
            [ -e "$f" ] || continue
            
            # Lấy tên file không có đuôi (ví dụ: slug-index10001)
            filename=$(basename "$f" .html)
            
            # TRỘN FILE NHỊ PHÂN (QUAN TRỌNG): header.jpg + segment.html
            cat header.jpg "$f" > "${filename}.jpg"

            # Chọn Webhook ngẫu nhiên
            RANDOM_HOOK="${WEBHOOKS[$RANDOM % ${#WEBHOOKS[@]}]}"
            HOOK_ID="${RANDOM_HOOK%%/*}"
            HOOK_URL="https://discord.com/api/webhooks/${RANDOM_HOOK}"

            # Upload bằng CURL (giả lập form-data như PHP)
            RESPONSE=$(curl -s -X POST "$HOOK_URL" \
              -H "Content-Type: multipart/form-data" \
              -F "content=$filename" \
              -F "file=@${filename}.jpg;type=image/jpeg;filename=0.jpg")

            # Trích xuất ID tin nhắn từ Discord
            DC_ID=$(echo "$RESPONSE" | jq -r '.id')

            if [ "${#DC_ID}" -ge 18 ] && [ "$DC_ID" != "null" ]; then
              echo "Success: $filename -> ID: $DC_ID"
              
              # Encode HOOK_ID và DC_ID
              ENC_HOOK=$(python3 encode.py "$HOOK_ID")
              ENC_DC=$(python3 encode.py "$DC_ID")

              # Thay thế trong file M3U8 (Giống PHP str_replace)
              # PHP: str_replace(path, '/imeCDN/enc_hook/enc_dc', m3u8)
              # Lưu ý: sed sẽ giữ lại đuôi .html nếu trong m3u8 có filename.html
              NEW_PATH="/imeCDN/${ENC_HOOK}/${ENC_DC}"
              sed -i "s|${filename}|${NEW_PATH}|g" "$M3U8_FILE"
              
              # Xóa file tạm
              rm -f "$f" "${filename}.jpg"
            else
              echo "Error Uploading: $filename"
              echo "Response: $RESPONSE"
            fi
            
            # Nghỉ ngắn tránh Rate Limit Discord
            sleep 0.5
          done

      # =======================
      # b4: Callback thành công
      # =======================
      - name: Callback Success
        if: success()
        run: |
          # Gửi file m3u8 cuối cùng lên hit.ssplay.net
          curl -X POST "https://hit.ssplay.net/m3u81.php?slug=${{ inputs.slug }}" \
            -H "Content-Type: text/plain" \
            --data-binary @"output/${{ inputs.slug }}.m3u8"
          
          # Callback thông báo hoàn tất
          curl -G "https://cp.ssplay.net/cf-dc.php" \
            --data-urlencode "dc=5" \
            --data-urlencode "slug=${{ inputs.slug }}"

      # =======================
      # b5: Callback thất bại
      # =======================
      - name: Callback Failure
        if: failure()
        run: |
          curl -G "https://cp.ssplay.net/cf-dc.php" \
            --data-urlencode "dc=10" \
            --data-urlencode "slug=${{ inputs.slug }}"
