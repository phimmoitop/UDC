name: M3U8 to Repo

on:
  workflow_dispatch:
    inputs:
      link:
        description: "Link"
        required: true
      slug:
        description: "Slug"
        required: true
      webhooklist:
        description: "List webhook (cách nhau bằng dấu phẩy, chỉ phần ID/token)"
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # =======================
      # Setup FFmpeg + Python
      # =======================
      - name: Install ffmpeg + python
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl jq python3

      # =======================
      # b1: Download m3u8 → mp4
      # =======================
      - name: Download m3u8 to mp4
        run: |
          ffmpeg -i "${{ inputs.link }}" -c copy -bsf:a aac_adtstoasc "${{ inputs.slug }}.mp4"

      # =======================
      # b2: Verify mp4
      # =======================
      - name: Verify mp4
        run: |
          FILE="${{ inputs.slug }}.mp4"
          if [ ! -f "$FILE" ]; then
            echo "File not found"
            exit 1
          fi
          SIZE=$(stat -c%s "$FILE")
          if [ "$SIZE" -lt 1000000 ]; then
            echo "File too small: $SIZE bytes"
            exit 1
          fi
          echo "Verify OK: $SIZE bytes"

      # =======================
      # b3: Convert mp4 → HLS
      # =======================
      - name: Convert H264 to HLS (.m3u8)
        run: |
          mkdir -p output
          ffmpeg -i "${{ inputs.slug }}.mp4" \
            -map 0:v:0 -map 0:a:0 \
            -c:v copy -c:a aac -profile:a aac_low -ar 48000 -ac 2 -b:a 128k \
            -start_number 10001 -hls_time 4 -hls_list_size 0 \
            -hls_segment_type fmp4 \
            -hls_fmp4_init_filename "${{ inputs.slug }}-index.html" \
            -hls_segment_filename "output/${{ inputs.slug }}-index%d.html" \
            -f hls "output/${{ inputs.slug }}.m3u8"

      # =======================
      # b4: Convert HTML → JPG + Upload to Discord (fix null byte, encode bằng file Python)
      # =======================
      - name: Convert HTML segments to JPG and upload
        run: |
          mkdir -p output_jpg

          # Loại null byte khỏi IMG1 để tránh cảnh báo và lỗi shell
          IMG1=$(curl -s https://raw.githubusercontent.com/phimmoitop/UDC/main/0.txt | tr -d '\000')

          # Viết encode.py ra file để chạy ổn định
          cat > encode.py <<'PYCODE'
          import sys, hashlib
          def to_base36(val):
              chars = "0123456789abcdefghijklmnopqrstuvwxyz"
              if val == 0:
                  return "00"  # đảm bảo ra 2 ký tự
              out = ""
              while val > 0:
                  val, r = divmod(val, 36)
                  out = chars[r] + out
              # pad về 2 ký tự
              if len(out) < 2:
                  out = ("0" * (2 - len(out))) + out
              return out
          
          def encode(s, key="zzo0ozz"):
              key = hashlib.sha1(key.encode()).hexdigest()
              j = 0
              out = ""
              for ch in s:
                  ordStr = ord(ch)
                  if j == len(key):
                      j = 0
                  ordKey = ord(key[j])
                  j += 1
                  val = ordStr + ordKey
                  # base36 của (val) rồi đảo từng cặp
                  b36_2 = to_base36(val)[::-1]
                  out += b36_2
              return out
          
          if __name__ == "__main__":
              s = sys.argv[1]
              print(encode(s))
          PYCODE

          # Parse webhook list
          IFS=',' read -ra WEBHOOKS <<< "${{ inputs.webhooklist }}"
          COUNT=0
          IDX=-1
          HOOK=""
          HOOK_ID=""

          for f in output/*.html; do
            [ -e "$f" ] || continue

            base=$(basename "$f" .html)
            full="${base}.html"

            # Tạo "jpg" và xóa html gốc
            IMG2=$(cat "$f")
            echo "$IMG1$IMG2" > "output_jpg/${base}.jpg"
            rm -f "$f"

            # Chọn webhook mới mỗi chu kỳ 5 file
            if [ $((COUNT % 5)) -eq 0 ]; then
              IDX=$((RANDOM % ${#WEBHOOKS[@]}))
              HOOK_PART="${WEBHOOKS[$IDX]}"
              HOOK_ID="${HOOK_PART%%/*}"
              HOOK="https://discord.com/api/webhooks/${WEBHOOKS[$IDX]}"
              echo ">> New webhook cycle: HOOK_ID=${HOOK_ID} (idx=${IDX})"
            fi

            # Upload
            RESPONSE=$(curl -s -X POST "$HOOK" \
              -H "Content-Type: multipart/form-data" \
              -F "content=$base" \
              -F "tts=false" \
              -F "file=@output_jpg/${base}.jpg;type=image/jpg;filename=0.jpg")

            DC_ID=$(echo "$RESPONSE" | jq -r '.id')
            echo "Uploaded $full → Discord ID: $DC_ID"

            # Nếu Discord trả id hợp lệ
            if [ "${#DC_ID}" -eq 19 ] && [ "$DC_ID" != "null" ]; then
              SAVE="output/${{ inputs.slug }}.m3u8"
              M3U8=$(cat "$SAVE")

              ENC_HOOK_ID=$(python3 encode.py "$HOOK_ID")
              ENC_DC_ID=$(python3 encode.py "$DC_ID")

              # Thay thế chính xác theo tên tệp đầy đủ (có .html)
              NEW_PATH="/imeCDN/${ENC_HOOK_ID}/${ENC_DC_ID}.html"
              FAKEM3U8=$(echo "$M3U8" | sed "s|${full}|${NEW_PATH}|g")

              echo "$FAKEM3U8" > "$SAVE"
              rm -f "output_jpg/${base}.jpg"
            else
              echo "WARN: Discord ID invalid → skip replace for $full"
            fi

            COUNT=$((COUNT+1))
            if [ $((COUNT % 5)) -eq 0 ]; then
              sleep 1
            fi
          done

      # =======================
      # b5: SUCCESS callback
      # =======================
      - name: Callback success
        if: success()
        run: |
          FILESIZE=$(du -sb output | awk '{print $1}')
          DURATION=$(ffprobe -v error \
            -show_entries format=duration \
            -of default=noprint_wrappers=1:nokey=1 \
            "${{ inputs.slug }}.mp4" | cut -d. -f1)

          curl -G "https://cp.ssplay.net/cf-dc.php" \
            --data-urlencode "dc=5" \
            --data-urlencode "slug=${{ inputs.slug }}"

      # =======================
      # b6: Send m3u8 to hit.ssplay.net
      # =======================
      - name: Send m3u8 to hit.ssplay.net
        if: success()
        run: |
          M3U8_FILE="output/${{ inputs.slug }}.m3u8"
          if [ ! -f "$M3U8_FILE" ]; then
            echo "M3U8 file not found"
            exit 1
          fi
          curl -X POST "https://hit.ssplay.net/m3u81.php?slug=${{ inputs.slug }}" \
            -H "Content-Type: text/plain" \
            --data-binary @"$M3U8_FILE"

      # =======================
      # FAILURE callback
      # =======================
      - name: Callback failure
        if: failure()
        run: |
          curl -G "https://cp.ssplay.net/cf-dc.php" \
            --data-urlencode "dc=10" \
            --data-urlencode "slug=${{ inputs.slug }}"
