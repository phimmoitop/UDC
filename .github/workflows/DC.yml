name: M3U8 to DC

on:
  workflow_dispatch:
    inputs:
      link:
        description: "Link"
        required: true
      slug:
        description: "Slug"
        required: true
      webhooklist:
        description: "List"
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Environment
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl jq python3

      # =======================
      # b1: Tải m3u8 → mp4
      # =======================
      - name: Download m3u8 to mp4
        run: |
          ffmpeg -i "${{ inputs.link }}" -c copy -bsf:a aac_adtstoasc "${{ inputs.slug }}.mp4"

      # =======================
      # b2: Cắt HLS (tạo ra các file .html thay vì .ts/fmp4)
      # =======================
      - name: Convert to HLS
        run: |
          mkdir -p output
          ffmpeg -y -i "${{ inputs.slug }}.mp4" -codec: copy \
            -start_number 10001 -hls_time 4 -hls_list_size 0 -f hls \
            -hls_segment_filename "output/${{ inputs.slug }}-index%d.html" \
            -f hls "output/${{ inputs.slug }}.m3u8"

      # =======================
      # b3: Trộn ảnh, Upload và Replace M3U8
      # =======================
      - name: Process and Upload to Discord
        run: |
          # 1. Tải file mồi JPG gốc (Nhị phân)
          curl -sL https://raw.githubusercontent.com/phimmoitop/UDC/main/0.txt -o header.jpg

          # 2. Python Script Encode (Clone logic PHP của bạn)
          cat > encode.py <<'PYCODE'
          import sys, hashlib

          def base_convert(n, from_base, to_base):
              try:
                  decimal = int(str(n), from_base)
              except: return "0"
              if decimal == 0: return "0"
              chars = "0123456789abcdefghijklmnopqrstuvwxyz"
              res = ""
              while decimal > 0:
                  decimal, r = divmod(decimal, to_base)
                  res = chars[r] + res
              return res

          def encode(string, key="zzo0ozz"):
              key_hash = hashlib.sha1(key.encode()).hexdigest()
              hash_out = ""
              j = 0
              for i in range(len(string)):
                  if j == len(key_hash): j = 0
                  # Logic PHP: strrev(base_convert(dechex(ordStr + ordKey),16,36))
                  val_dec = ord(string[i]) + ord(key_hash[j])
                  val_hex = hex(val_dec)[2:]
                  val_b36 = base_convert(val_hex, 16, 36)
                  hash_out += val_b36[::-1]
                  j += 1
              return hash_out

          if __name__ == "__main__":
              if len(sys.argv) > 1:
                  print(encode(sys.argv[1]))
          PYCODE

          # 3. Duyệt danh sách file .html vừa tạo ra
          IFS=',' read -ra WEBHOOKS <<< "${{ inputs.webhooklist }}"
          M3U8_FILE="output/${{ inputs.slug }}.m3u8"
          
          # Lấy danh sách file theo đúng thứ tự
          FILES=$(ls output/*.html)

          for f in $FILES; do
            [ -e "$f" ] || continue
            
            # Tên file gốc (ví dụ: phim-index10001)
            filename_no_ext=$(basename "$f" .html)
            
            # TRỘN FILE: Nối header.jpg vào trước nội dung video .html
            # Điều này giúp Discord nhận diện đây là file ảnh hợp lệ
            cat header.jpg "$f" > "${filename_no_ext}.jpg"

            # Chọn Webhook ngẫu nhiên
            RANDOM_HOOK="${WEBHOOKS[$RANDOM % ${#WEBHOOKS[@]}]}"
            HOOK_ID="${RANDOM_HOOK%%/*}"
            HOOK_URL="https://discord.com/api/webhooks/${RANDOM_HOOK}"

            # Upload lên Discord
            RESPONSE=$(curl -s -X POST "$HOOK_URL" \
              -H "Content-Type: multipart/form-data" \
              -F "content=$filename_no_ext" \
              -F "file=@${filename_no_ext}.jpg;type=image/jpeg;filename=0.jpg")

            # Lấy ID từ phản hồi Discord
            DC_ID=$(echo "$RESPONSE" | jq -r '.id')

            if [ "${#DC_ID}" -ge 18 ] && [ "$DC_ID" != "null" ]; then
              echo "Uploaded: $filename_no_ext -> DC_ID: $DC_ID"
              
              # Encode theo logic PHP
              ENC_HOOK=$(python3 encode.py "$HOOK_ID")
              ENC_DC=$(python3 encode.py "$DC_ID")

              # THAY THẾ TRONG M3U8:
              # Tìm: slug-index10001.html
              # Thay: /imeCDN/encoded_hook/encoded_dc.html
              # (Giữ lại .html cuối cùng như yêu cầu)
              NEW_VAL="/imeCDN/${ENC_HOOK}/${ENC_DC}.html"
              
              sed -i "s|${filename_no_ext}\.html|${NEW_VAL}|g" "$M3U8_FILE"
              
              # Xóa file tạm để tránh đầy ổ cứng
              rm -f "$f" "${filename_no_ext}.jpg"
            else
              echo "FAILED: $filename_no_ext"
            fi
            
            # Nghỉ 0.5s để tránh Discord Rate Limit
            sleep 0.5
          done

      # =======================
      # b4: Hoàn tất và gửi dữ liệu
      # =======================
      - name: Finalize
        if: success()
        run: |
          # Gửi nội dung m3u8 đã sửa tới server hit
          curl -X POST "https://hit.ssplay.net/m3u81.php?slug=${{ inputs.slug }}" \
            -H "Content-Type: text/plain" \
            --data-binary @"output/${{ inputs.slug }}.m3u8"
          
          # Callback báo thành công
          curl -G "https://cp.ssplay.net/cf-dc.php" \
            --data-urlencode "dc=5" \
            --data-urlencode "slug=${{ inputs.slug }}"

      - name: Callback Failure
        if: failure()
        run: |
          curl -G "https://cp.ssplay.net/cf-dc.php" \
            --data-urlencode "dc=10" \
            --data-urlencode "slug=${{ inputs.slug }}"
