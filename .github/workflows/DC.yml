name: M3U8 to DC

on:
  workflow_dispatch:
    inputs:
      link:
        description: "Link"
        required: true
      slug:
        description: "Slug"
        required: true
      webhooklist:
        description: "List"
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # =======================
      # Setup FFmpeg + Python
      # =======================
      - name: Install ffmpeg + python
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl jq python3

      # =======================
      # b1: Download m3u8 → mp4
      # =======================
      - name: Download m3u8 to mp4
        run: |
          ffmpeg -i "${{ inputs.link }}" -c copy -bsf:a aac_adtstoasc "${{ inputs.slug }}.mp4"

      # =======================
      # b2: Verify mp4
      # =======================
      - name: Verify mp4
        run: |
          FILE="${{ inputs.slug }}.mp4"
          if [ ! -f "$FILE" ]; then
            echo "File not found"
            exit 1
          fi
          SIZE=$(stat -c%s "$FILE")
          if [ "$SIZE" -lt 1000000 ]; then
            echo "File too small: $SIZE bytes"
            exit 1
          fi
          echo "Verify OK: $SIZE bytes"

      # =======================
      # b3: Convert mp4 → HLS
      # =======================
      - name: Convert H264 to HLS (.m3u8)
        run: |
          mkdir -p output
          ffmpeg -i "${{ inputs.slug }}.mp4" \
            -map 0:v:0 -map 0:a:0 \
            -c:v copy -c:a aac -profile:a aac_low -ar 48000 -ac 2 -b:a 128k \
            -start_number 10001 -hls_time 4 -hls_list_size 0 \
            -hls_segment_type fmp4 \
            -hls_fmp4_init_filename "${{ inputs.slug }}-index.html" \
            -hls_segment_filename "output/${{ inputs.slug }}-index%d.html" \
            -f hls "output/${{ inputs.slug }}.m3u8"

      # =======================
      # b4: Convert HTML → JPG + Upload to Discord
      # =======================
      - name: Convert HTML segments to JPG and upload
        run: |
          mkdir -p output_jpg
          IMG1=$(curl -s https://raw.githubusercontent.com/phimmoitop/UDC/main/0.txt)

          IFS=',' read -ra WEBHOOKS <<< "${{ inputs.webhooklist }}"
          COUNT=0
          IDX=-1
          HOOK=""
          HOOK_ID=""

          encode_py=$(cat <<'PYCODE'
          import sys, hashlib
          def encode(s, key="zzo0ozz"):
              key = hashlib.sha1(key.encode()).hexdigest()
              j = 0
              out = ""
              for ch in s:
                  ordStr = ord(ch)
                  if j == len(key): j = 0
                  ordKey = ord(key[j])
                  j += 1
                  val = ordStr + ordKey
                  h = format(val, "x")
                  n = int(h, 16)
                  b36 = ""
                  while n>0:
                      n, r = divmod(n, 36)
                      b36 = "0123456789abcdefghijklmnopqrstuvwxyz"[r] + b36
                  out += b36[::-1]
              return out
          print(encode(sys.argv[1]))
          PYCODE
          )

          for f in output/*.html; do
            [ -e "$f" ] || continue
            path=$(basename "$f" .html)
            IMG2=$(cat "$f")
            echo "$IMG1$IMG2" > "output_jpg/${path}.jpg"
            rm -f "$f"

            # chọn webhook mới khi bắt đầu chu kỳ
            if [ $COUNT -eq 0 ]; then
              IDX=$((RANDOM % ${#WEBHOOKS[@]}))
              HOOK_PART="${WEBHOOKS[$IDX]}"
              HOOK_ID="${HOOK_PART%%/*}"
              HOOK="https://discord.com/api/webhooks/${WEBHOOKS[$IDX]}"
            fi

            RESPONSE=$(curl -s -X POST "$HOOK" \
              -H "Content-Type: multipart/form-data" \
              -F "content=$path" \
              -F "tts=false" \
              -F "file=@output_jpg/${path}.jpg;type=image/jpg;filename=0.jpg")

            DC_ID=$(echo "$RESPONSE" | jq -r '.id')
            echo "Uploaded $path → $DC_ID"

            if [ "${#DC_ID}" -eq 19 ]; then
              SAVE="output/${{ inputs.slug }}.m3u8"
              M3U8=$(cat "$SAVE")

              ENC_HOOK_ID=$(python3 -c "$encode_py" "$HOOK_ID")
              ENC_DC_ID=$(python3 -c "$encode_py" "$DC_ID")

              FAKEM3U8=$(echo "$M3U8" | sed "s|$path|/imeCDN/${ENC_HOOK_ID}/${ENC_DC_ID}|g")
              echo "$FAKEM3U8" > "$SAVE"
              rm -f "output_jpg/${path}.jpg"
            fi

            COUNT=$((COUNT+1))
            if [ $COUNT -eq 5 ]; then
              COUNT=0
              sleep 1
            fi
          done

      # =======================
      # b5: SUCCESS callback
      # =======================
      - name: Callback success
        if: success()
        run: |
          FILESIZE=$(du -sb output | awk '{print $1}')
          DURATION=$(ffprobe -v error \
            -show_entries format=duration \
            -of default=noprint_wrappers=1:nokey=1 \
            "${{ inputs.slug }}.mp4" | cut -d. -f1)

          curl -G "https://cp.ssplay.net/cf-dc.php" \
            --data-urlencode "dc=5" \
            --data-urlencode "slug=${{ inputs.slug }}"

      # =======================
      # b6: Send m3u8 to hit.ssplay.net
      # =======================
      - name: Send m3u8 to hit.ssplay.net
        if: success()
        run: |
          M3U8_FILE="output/${{ inputs.slug }}.m3u8"
          if [ ! -f "$M3U8_FILE" ]; then
            echo "M3U8 file not found"
            exit 1
          fi
          curl -X POST "https://hit.ssplay.net/m3u81.php?slug=${{ inputs.slug }}" \
            -H "Content-Type: text/plain" \
            --data-binary @"$M3U8_FILE"

      # =======================
      # FAILURE callback
      # =======================
      - name: Callback failure
        if: failure()
        run: |
          curl -G "https://cp.ssplay.net/cf-dc.php" \
            --data-urlencode "dc=10" \
            --data-urlencode "slug=${{ inputs.slug }}"
