name: M3U8 to DC

on:
  workflow_dispatch:
    inputs:
      link:
        description: "Link"
        required: true
      slug:
        description: "Slug"
        required: true
      webhooklist:
        description: "List"
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # =======================
      # Setup FFmpeg + Python
      # =======================
      - name: Install ffmpeg + python
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl jq python3

      # =======================
      # b1: Download m3u8 → mp4
      # =======================
      - name: Download m3u8 to mp4
        run: |
          ffmpeg -i "${{ inputs.link }}" -c copy -bsf:a aac_adtstoasc "${{ inputs.slug }}.mp4"

      # =======================
      # b2: Verify mp4
      # =======================
      - name: Verify mp4
        run: |
          FILE="${{ inputs.slug }}.mp4"
          if [ ! -f "$FILE" ]; then
            echo "File not found"
            exit 1
          fi
          SIZE=$(stat -c%s "$FILE")
          if [ "$SIZE" -lt 1000000 ]; then
            echo "File too small: $SIZE bytes"
            exit 1
          fi
          echo "Verify OK: $SIZE bytes"

      # =======================
      # b3: Convert mp4 → HLS
      # =======================
      - name: Convert H264 to HLS (.m3u8)
        run: |
          mkdir -p output
          ffmpeg -i "${{ inputs.slug }}.mp4" \
            -map 0:v:0 -map 0:a:0 \
            -c:v copy -c:a aac -profile:a aac_low -ar 48000 -ac 2 -b:a 128k \
            -start_number 10001 -hls_time 4 -hls_list_size 0 \
            -hls_segment_type fmp4 \
            -hls_fmp4_init_filename "${{ inputs.slug }}-index.html" \
            -hls_segment_filename "output/${{ inputs.slug }}-index%d.html" \
            -f hls "output/${{ inputs.slug }}.m3u8"

      # =======================
      # b4: Convert HTML → JPG + Upload to Discord
      # =======================
      - name: Convert HTML segments to JPG and upload
        run: |
          mkdir -p output_jpg

          # Loại null byte khỏi IMG1
          IMG1=$(curl -s https://raw.githubusercontent.com/phimmoitop/UDC/main/0.txt | tr -d '\000')

          # Viết encode.py mô phỏng chính xác hàm PHP
          cat > encode.py <<'PYCODE'
          import sys
          import hashlib

          def base_convert(n, from_base, to_base):
              # Chuyển n (ở hệ from_base) sang thập phân trước
              decimal_n = int(str(n), from_base)
              if decimal_n == 0:
                  return "0"
              # Chuyển thập phân sang hệ to_base
              chars = "0123456789abcdefghijklmnopqrstuvwxyz"
              res = ""
              while decimal_n > 0:
                  decimal_n, r = divmod(decimal_n, to_base)
                  res = chars[r] + res
              return res

          def encode(string, key="zzo0ozz"):
              key_hash = hashlib.sha1(key.encode()).hexdigest()
              str_len = len(string)
              key_len = len(key_hash)
              hash_out = ""
              j = 0
              for i in range(str_len):
                  ord_str = ord(string[i])
                  if j == key_len:
                      j = 0
                  ord_key = ord(key_hash[j])
                  j += 1
                  
                  # PHP: dechex(ordStr + ordKey)
                  hex_val = hex(ord_str + ord_key)[2:]
                  # PHP: base_convert(..., 16, 36)
                  b36_val = base_convert(hex_val, 16, 36)
                  # PHP: strrev(...)
                  hash_out += b36_val[::-1]
              return hash_out

          if __name__ == "__main__":
              if len(sys.argv) > 1:
                  print(encode(sys.argv[1]))
          PYCODE

          # Parse webhook list
          IFS=',' read -ra WEBHOOKS <<< "${{ inputs.webhooklist }}"
          COUNT=0
          IDX=-1
          HOOK=""
          HOOK_ID=""

          for f in output/*.html; do
            [ -e "$f" ] || continue

            base=$(basename "$f" .html)
            full="${base}.html"

            # Tạo "jpg"
            IMG2=$(cat "$f")
            echo "$IMG1$IMG2" > "output_jpg/${base}.jpg"
            rm -f "$f"

            # Chọn webhook ngẫu nhiên mỗi 5 file
            if [ $((COUNT % 5)) -eq 0 ]; then
              IDX=$((RANDOM % ${#WEBHOOKS[@]}))
              HOOK_PART="${WEBHOOKS[$IDX]}"
              HOOK_ID="${HOOK_PART%%/*}"
              HOOK="https://discord.com/api/webhooks/${WEBHOOKS[$IDX]}"
              echo ">> New webhook cycle: HOOK_ID=${HOOK_ID}"
            fi

            # Upload lên Discord
            RESPONSE=$(curl -s -X POST "$HOOK" \
              -H "Content-Type: multipart/form-data" \
              -F "content=$base" \
              -F "file=@output_jpg/${base}.jpg;type=image/jpg;filename=0.jpg")

            DC_ID=$(echo "$RESPONSE" | jq -r '.id')
            
            if [ "${#DC_ID}" -ge 17 ] && [ "$DC_ID" != "null" ]; then
              SAVE="output/${{ inputs.slug }}.m3u8"
              
              # Encode HOOK_ID và DC_ID bằng script Python mới
              ENC_HOOK_ID=$(python3 encode.py "$HOOK_ID")
              ENC_DC_ID=$(python3 encode.py "$DC_ID")

              NEW_PATH="/imeCDN/${ENC_HOOK_ID}/${ENC_DC_ID}.html"
              
              # Cập nhật file m3u8
              sed -i "s|${full}|${NEW_PATH}|g" "$SAVE"
              rm -f "output_jpg/${base}.jpg"
            else
              echo "WARN: Discord ID invalid for $full"
            fi

            COUNT=$((COUNT+1))
            if [ $((COUNT % 5)) -eq 0 ]; then sleep 1; fi
          done

      # =======================
      # b5: SUCCESS callback
      # =======================
      - name: Callback success
        if: success()
        run: |
          curl -G "https://cp.ssplay.net/cf-dc.php" \
            --data-urlencode "dc=5" \
            --data-urlencode "slug=${{ inputs.slug }}"

      # =======================
      # b6: Send m3u8 to hit.ssplay.net
      # =======================
      - name: Send m3u8 to hit.ssplay.net
        if: success()
        run: |
          M3U8_FILE="output/${{ inputs.slug }}.m3u8"
          curl -X POST "https://hit.ssplay.net/m3u81.php?slug=${{ inputs.slug }}" \
            -H "Content-Type: text/plain" \
            --data-binary @"$M3U8_FILE"

      # =======================
      # FAILURE callback
      # =======================
      - name: Callback failure
        if: failure()
        run: |
          curl -G "https://cp.ssplay.net/cf-dc.php" \
            --data-urlencode "dc=10" \
            --data-urlencode "slug=${{ inputs.slug }}"
